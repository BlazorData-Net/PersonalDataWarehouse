@page "/views"
@using System.Text.Json
@using System.Linq.Dynamic.Core
@using CSScriptLib
@using System.Reflection
@using System.Text
@using OpenAI;
@using Microsoft.Extensions.AI;
@using System.Diagnostics.CodeAnalysis
@using PersonalDataWarehouse.AI
@using PersonalDataWarehouse.Services
@using PersonalDataWarehouse.Model
@using MonacoRazor
@using System.Data
@using System.Text.Json.Nodes
@inject IJSRuntime JSRuntime
@inject DatabaseService databaseService
@inject DataService DataService
@inject SettingsService SettingsService
@inject OrchestratorMethods OrchestratorMethods
@inject LogService _LogService

<PageTitle>Views</PageTitle>

<h4>Views</h4>
<br />
@if (IsLoading)
{
    <div role="progressbar" class="marquee" style="width: 25%"></div>
}
else
{
    <div>
        @if (ViewList.Count > 0)
        {
            @if (CurrentViewName != "")
            {
                <label>Select View: </label>
                <select @onchange="@(async (args) =>
                    {
                        CurrentViewName = args.Value?.ToString();
                        await LoadViewAsync(CurrentViewName);
                    })">
                    @foreach (var view in ViewList)
                    {
                        <option value="@view"
                        selected="@(view == CurrentViewName ? "selected" : null)">
                            @view
                        </option>
                    }
                </select>
            }
            else
            {
                <button @onclick="Reset">Reset</button>
            }
        }
    </div>
    <br />
    <div>
        <div class="rz-p-sm-1" style="background-color:whitesmoke; border-block:thin; border-block-color:lightgray; text-align:left">
            @if (TableList.Count > 0)
            {
                <button @onclick="OpenWizard" title="Table Wizard" style="background:none;border:none;">
                    <i class="material-icons" style="color:black;">flash_on</i>
                </button>
            }

            <button @onclick="NewScript" title="New" style="background:none;border:none;">
                <i class="material-icons" style="color:black;">note_add</i>
            </button>

            <button @onclick="SaveViewName" title="Save" style="background:none;border:none;">
                <i class="material-icons" style="color:black;">save</i>
            </button>

            <button disabled="@(CanUndo == false)" @onclick="() => Undo()" title="Undo" style="background:none;border:none;">
                <i class="material-icons" style="color:black;">undo</i>
            </button>

            <button disabled="@(CanRedo == false)" @onclick="() => Redo()" title="Redo" style="background:none;border:none;">
                <i class="material-icons" style="color:black;">redo</i>
            </button>

            @if (!string.IsNullOrEmpty(CurrentViewName))
            {
                <button @onclick="DeleteConfirmation" title="Delete" style="background:none;border:none;">
                    <i class="material-icons" style="color:black;">delete</i>
                </button>
            }

            <button @onclick="Execute" title="Execute" style="background:none;border:none;">
                <i class="material-icons" style="color:black;">play_arrow</i>
            </button>

            <button @onclick="Export" title="Export" style="background:none;border:none;">
                <i class="material-icons" style="color:black;">file_download</i>
            </button>

            <button @onclick="OpenAIPopup" title="AI" style="background:none;border:none;">
                <i class="material-icons" style="color:black;">psychology</i>
            </button>
            @if (ContentChanged)
            {
                <span style="color:red">&nbsp;&nbsp;<b>Editing...</b></span>
            }
        </div>
        <CodeEditor @ref="@MonacoCodeEditor"
        Language="@MonacoLanguage"
        Code="@CurrentScript"
        MinHeight="500px"
        Width="90%"
        Margin="0px"
        OnCompletionsRequested="GetCompletionsAsync" />
    </div>
    <br />
}

<!-- POPUPS -->
@if (IsNewOutputPopupVisible)
{
    <div class="modal fade show" style="display: block;" tabindex="-1">
        <div class="modal-dialog" style="max-width: 90%; margin-top: 5%;">
            <div class="modal-content">
                <div class="window glass active">
                    <div class="title-bar">
                        <div class="title-bar-text">Output</div>
                        <div class="title-bar-controls">
                            <button aria-label="Close" @onclick="CloseOutputTablePopup"></button>
                        </div>
                    </div>
                    <div class="window-body has-space">
                        @if (IsOutputLoading)
                        {
                            <div role="progressbar" class="marquee" style="width: 100%"></div>
                        }
                        else
                        {
                            <RadzenDataGrid Data="@objDataParameters.data"
                            ColumnWidth="200px"
                            AllowFiltering="false" AllowPaging="true" AllowSorting="false">
                                <Columns>
                                    @foreach (var column in objDataParameters.columns)
                                    {
                                        <RadzenDataGridColumn @key=@column.Key
                                        Title="@column.Key"
                                        Type="column.Value"
                                        Property="@PropertyAccess.GetDynamicPropertyExpression(column.Key, column.Value)">
                                            <Template>
                                                @context[@column.Key]
                                            </Template>
                                        </RadzenDataGridColumn>
                                    }
                                </Columns>
                            </RadzenDataGrid>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@if (IsNewViewVisible)
{
    <div class="modal fade show" style="display: block;" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="window glass active">
                    <div class="title-bar">
                        <div class="title-bar-text">New View</div>
                        <div class="title-bar-controls">
                            <button aria-label="Close" @onclick="CloseNewScriptPopup"></button>
                        </div>
                    </div>
                    <div class="window-body has-space">
                        <label>Select Language: </label>
                        <select @bind="CurrentSelectedLanguageWizard">
                            @foreach (var lng in LanguageList)
                            {
                                <option value="@lng">@lng</option>
                            }
                        </select>
                        &nbsp;&nbsp;
                        <button @onclick="onLanguageSelectedAsync">Select</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@if (IsWizardVisible)
{
    <div class="modal fade show" style="display: block;" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="window glass active">
                    <div class="title-bar">
                        <div class="title-bar-text">Table Wizard</div>
                        <div class="title-bar-controls">
                            <button aria-label="Close" @onclick="CloseTableWizardPopup"></button>
                        </div>
                    </div>
                    <div class="window-body has-space">
                        <label>Select Table: </label>
                        <select @onchange="@(async (args) =>
                            {
                                CurrentSelectedTableWizard = args.Value?.ToString();
                            })">
                            @foreach (var table in TableList)
                            {
                                <option value="@table">
                                    @table
                                </option>
                            }
                        </select>
                    </div>
                    <div class="window-body has-space">
                        <label>Select Language: </label>
                        <select @bind="CurrentSelectedLanguageWizard">
                            @foreach (var lng in LanguageList)
                            {
                                <option value="@lng">@lng</option>
                            }
                        </select>
                        &nbsp;&nbsp;
                        <button @onclick="onTableWizardAsync">Select</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}


@if (IsSaveViewPopupVisible)
{
    <div class="modal fade show" style="display: block;" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="window glass active">
                    <div class="title-bar">
                        <div class="title-bar-text">Save View</div>
                        <div class="title-bar-controls">
                            <button aria-label="Close" @onclick="CloseNewViewPopup"></button>
                        </div>
                    </div>
                    <div class="window-body has-space">
                        <form @onsubmit="SaveViewAsync">
                            <div>
                                <label>Select Database: </label>
                                <select @onchange="@(async (args) =>
                                {
                                    CurrentDatabaseName = args.Value?.ToString();
                                })">
                                    @foreach (var database in colAllDatabases)
                                    {
                                        <option value="@database"
                                        selected="@(database == CurrentDatabaseName ? "selected" : null)">
                                            @database
                                        </option>
                                    }
                                </select>
                            </div>
                            <br />
                            <div>
                                <label for="tableName">View Name:</label>
                                <input type="text" id="tableName" maxlength="50" style="width: 300px;" @bind="CurrentViewNameWithoutDatabase" />
                                &nbsp;&nbsp;&nbsp;&nbsp;
                                <button type="submit">Submit</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}


@if (ShowAI)
{
    <div class="modal fade show" style="display: block;" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="window glass active">
                    <div class="title-bar">
                        <div class="title-bar-text">AI Prompt</div>
                        <div class="title-bar-controls">
                            <button aria-label="Close" @onclick="CloseAIPopup"></button>
                        </div>
                    </div>
                    <div class="window-body has-space" style="text-align: center;">
                        @if (IsAILoading)
                        {
                            <div role="progressbar" class="marquee" style="width: 100%"></div>
                        }
                        else
                        {
                            <div class="has-scrollbar" style="width: 100%; height: 110px; overflow: auto">
                                <textarea @bind="AIMessage" maxlength="1000"
                                style="width: 100%; height: 100px; overflow: auto; resize: vertical;">
                                </textarea>
                            </div>
                            <br />
                            <button @onclick="AIbtn">Submit</button>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@if (ShowDeleteConfirmation)
{
    <div class="modal fade show" style="display: block;" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="window glass active">
                    <div class="title-bar">
                        <div class="title-bar-text">Confirm Delete</div>
                        <div class="title-bar-controls">
                            <button aria-label="Close" @onclick="CloseDeleteConfirmationPopup"></button>
                        </div>
                    </div>
                    <div class="window-body has-space" style="text-align: center;">

                        <span>&nbsp; &nbsp;</span>
                        <button @onclick="DeleteAsync">Yes</button>
                        <span>&nbsp; &nbsp;</span>
                        <button @onclick="CloseDeleteConfirmationPopup">No</button>

                    </div>
                </div>

            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@if (IsExportVisible)
{
    <div class="modal fade show" style="display: block;" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="window glass active">
                    <div class="title-bar">
                        <div class="title-bar-text">Export</div>
                        <div class="title-bar-controls">
                            <button aria-label="Close" @onclick="CloseExportPopup"></button>
                        </div>
                    </div>
                    <div class="window-body has-space" style="text-align: center;">

                        <div role="progressbar" class="marquee" style="width: 100%; display: @(IsLoadingSheet ? "block" : "none");"></div>

                        <div style="display: @(IsLoadingSheet ? "none" : "block");">
                            <span>&nbsp; &nbsp;</span>
                            <button @onclick="ExportExcel">Excel</button>
                            <span>&nbsp; &nbsp;</span>
                            <button @onclick="ExportParquet">Parquet</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@if (Message != "")
{
    <div class="modal fade show" style="display: block;" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="window glass active">
                    <div class="title-bar">
                        <div class="title-bar-text">Alert!</div>
                        <div class="title-bar-controls">
                            <button aria-label="Close" @onclick="CloseMessagePopup"></button>
                        </div>
                    </div>
                    <div class="window-body has-space">
                        <div class="has-scrollbar" style="width: 100%; height: 100px; overflow: auto">
                            @Message
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@code {
    private CodeEditor MonacoCodeEditor { get; set; }
    private string MonacoLanguage = "csharp";
    private bool ContentChanged { get; set; }
    private string CurrentScript { get; set; } = string.Empty;

    private DataParameters objDataParameters = new DataParameters();

    private bool IsLoading { get; set; } = false;
    private bool IsAILoading { get; set; } = false;
    private bool IsOutputLoading { get; set; } = false;
    private List<string> TableList = new List<string>();
    private List<string> ViewList = new List<string>();
    private string DataSchema = "";
    private string CurrentViewName = "";
    private string CurrentViewNameWithoutDatabase = string.Empty;
    string CurrentSelectedLanguageWizard = "C#";
    bool IsNewViewVisible { get; set; } = false;

    List<Suggestion> suggestions = new List<Suggestion>();
    List<string> colAllDatabases = new List<string>();
    string CurrentDatabaseName = "Default";

    private Stack<string> undoStack = new();
    private Stack<string> redoStack = new();
    private bool CanUndo => undoStack.Count > 0;
    private bool CanRedo => redoStack.Count > 0;

    private bool IsWizardVisible { get; set; } = false;
    private bool IsSaveViewPopupVisible { get; set; } = false;
    private bool IsNewOutputPopupVisible { get; set; } = false;
    private bool IsExportVisible { get; set; } = false;
    private bool IsLoadingSheet { get; set; } = false;
    private string CurrentSelectedTableWizard = "";

    private bool ShowDeleteConfirmation { get; set; } = false;

    private bool ShowAI { get; set; } = false;
    private string AIMessage = "";

    string Message = "";

    protected override void OnInitialized()
    {
        objDataParameters = new DataParameters();
        objDataParameters.data = new List<IDictionary<string, object>>();
        objDataParameters.columns = new Dictionary<string, Type>();
    }

    protected override async Task OnInitializedAsync()
    {
        DataSchema = await databaseService.GetAllTableSchemaAsync();
        suggestions = await databaseService.GetAllTableCompletionsAsync();
        await LoadViewsListDropdownAsync();
        colAllDatabases = await databaseService.GetAllDatabasesAsync();
        await LoadTableListDropdownAsync();

        if (ViewList.Count > 0)
        {
            CurrentViewName = ViewList.First();

            // Separate the view name from the database
            var (Database, View) = DataService.ExtractDatabaseAndTable(CurrentViewName);

            // Load the DataTable
            String viewsFolder = $"{System.Environment.GetFolderPath(System.Environment.SpecialFolder.MyDocuments)}/PersonalDataWarehouse/Databases/{Database}/Views";

            var fileName = $"{viewsFolder}/{View}.view";

            if (System.IO.File.Exists(fileName))
            {
                // Read contents into CurrentScript
                CurrentScript = System.IO.File.ReadAllText(fileName);
                StateHasChanged();
            }
        }
        else
        {
            CurrentScript = SampleCodeCSharp;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            if (ViewList.Count > 0)
            {
                CurrentViewName = ViewList.First();
                await LoadViewAsync(CurrentViewName);
            }
        }
    }

    Task<Suggestion[]> GetCompletionsAsync(string currentValue, Position position)
    {
        // Search suggestions
        var result = suggestions.Where(x => x.Label.StartsWith(currentValue, StringComparison.OrdinalIgnoreCase)).ToArray();

        return Task.FromResult(result);
    }

    // Undo/Redo

    // Called when the user clicks the Undo button.
    private async Task Undo()
    {
        if (CanUndo)
        {
            // Get the current script
            CurrentScript = await MonacoCodeEditor.GetCodeAsync();

            // Push the current text onto the redo stack.
            redoStack.Push(CurrentScript);

            // Pop the last state from the undo stack and set it as the current text.
            CurrentScript = undoStack.Pop();

            MonacoLanguage = DataService.GetDetectedLanguage(CurrentScript);
            await MonacoCodeEditor.UpdateCodeAsync(CurrentScript);
        }
    }

    // Called when the user clicks the Redo button.
    private async Task Redo()
    {
        if (CanRedo)
        {
            // Get the current script
            CurrentScript = await MonacoCodeEditor.GetCodeAsync();

            // Push the current state onto the undo stack.
            undoStack.Push(CurrentScript);

            // Pop the last undone state from the redo stack and set it as the current text.
            CurrentScript = redoStack.Pop();

            MonacoLanguage = DataService.GetDetectedLanguage(CurrentScript);
            await MonacoCodeEditor.UpdateCodeAsync(CurrentScript);
        }
    }

    // SAVE

    private void SaveViewName()
    {
        if (CurrentViewName != "")
        {
            // Separate the view name from the database
            var (Database, View) = DataService.ExtractDatabaseAndTable(CurrentViewName);

            CurrentViewNameWithoutDatabase = View;
        }
        else
        {
            CurrentViewNameWithoutDatabase = "";
        }

        IsSaveViewPopupVisible = true;
    }

    // This method is called when a save does not request a view name
    private async Task SaveViewAsync()
    {
        try
        {
            CurrentViewNameWithoutDatabase = CurrentViewNameWithoutDatabase.Trim();

            if (string.IsNullOrEmpty(CurrentViewNameWithoutDatabase))
            {
                Message = "Please enter a view name.";
                return;
            }

            IsLoading = true;

            // Remove spaces and special characters
            string CleanedName = databaseService.RemoveSpacesSpecialCharacters(CurrentViewNameWithoutDatabase);

            if (CleanedName != CurrentViewNameWithoutDatabase)
            {
                IsLoading = false;
                CurrentViewNameWithoutDatabase = CleanedName;
                Message = $"View Name will be {CurrentViewNameWithoutDatabase}";
                return;
            }

            // Check for duplicates
            if (DetectDuplicates(CurrentDatabaseName, CurrentViewNameWithoutDatabase))
            {
                IsLoading = false;
                Message = "A Table or Report with this name already exists.";
                return;
            }

            // Save to file in Data/Views
            String viewsFolder = $"{System.Environment.GetFolderPath(System.Environment.SpecialFolder.MyDocuments)}/PersonalDataWarehouse/Databases/{CurrentDatabaseName}/Views";

            var fileName = Path.Combine(viewsFolder, $"{CurrentViewNameWithoutDatabase}.view");

            // Get the current script
            CurrentScript = await MonacoCodeEditor.GetCodeAsync();

            // Update the Undo stack
            undoStack.Push(CurrentScript);

            await System.IO.File.WriteAllTextAsync(fileName, CurrentScript);

            // Execute the code (because we need to get the columns returned)
            var objResult = await RunDynamicCode(CurrentScript);

            List<string> columns = new List<string>();

            if (objResult != null)
            {
                // Parse objDataParametersResult.data to a list of dictionaries
                // Only get the first row to get the columns
                var TempColumns = objResult.Select(x => x.ToDictionary(y => y.Key, y => y.Value)).FirstOrDefault();

                columns = TempColumns.Keys.ToList();
            }

            // ** Build the class definition and dictionary mapping

            // Build the class definition
            StringBuilder ClassDefinition = new StringBuilder();
            ClassDefinition.AppendLine($"public class {DataService.FirstCharToUpper(CurrentViewNameWithoutDatabase)}");
            ClassDefinition.AppendLine("    {");

            // See if there is a column named Id
            bool hasId = false;

            foreach (var column in columns)
            {
                if (column.ToLower() == "id")
                {
                    hasId = true;
                    break;
                }
            }

            // Only add the Id property if it doesn't exist
            if (!hasId)
            {
                // Add an Id property to the class
                ClassDefinition.AppendLine("        public int Id { get; set; }");
            }

            // For each column in the DataTable, create a string property
            foreach (var column in columns)
            {
                // Ensure the property name is a valid C# identifier
                string propertyName = column.Replace(" ", "_");

                // Replace - with _ to make it a valid C# identifier
                propertyName = propertyName.Replace("-", "_");

                ClassDefinition.AppendLine
                ($"        public string {propertyName} {{ get; set; }}");
            }

            ClassDefinition.AppendLine("    }");

            // Build the dictionaryMapping
            StringBuilder DictionaryMapping = new StringBuilder();

            foreach (var column in columns)
            {
                // Replace spaces in the column name with underscores to make it a valid C# identifier
                string propertyName = column.Replace(" ", "_");

                // Replace - with _ to make it a valid C# identifier
                propertyName = propertyName.Replace("-", "_");

                // Build the line:
                DictionaryMapping.AppendLine(
                    $"                        {propertyName} = dict.ContainsKey(\"{propertyName}\") "
                    + "? dict[\"{propertyName}\"]?.ToString() : null,");
            }

            // ** Open the View.txt template from Templates\View.txt and replace the content with the codeBuilder
            string templatePath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "Templates", "View.txt");

            // Read the content of the template file
            string templateContent = File.ReadAllText(templatePath);

            // Replace the placeholders
            string codeBuilder = "";

            codeBuilder = templateContent.Replace("**CLASS NAME**", DataService.FirstCharToUpper(CurrentViewNameWithoutDatabase));
            codeBuilder = codeBuilder.Replace("**CLASS DEFINITION**", ClassDefinition.ToString());
            codeBuilder = codeBuilder.Replace("**DICTIONARY MAPPING**", DictionaryMapping.ToString());
            codeBuilder = codeBuilder.Replace("**CLASS UPPERCASE WITH AN S**", (DataService.FirstCharToUpper(CurrentViewNameWithoutDatabase) + "s"));
            codeBuilder = codeBuilder.Replace("**CLASS LOWERCASE WITH AN S**", (CurrentViewNameWithoutDatabase.ToLower() + "s"));
            codeBuilder = codeBuilder.Replace("**FIRST FIELD**", columns[0]);

            // ** Write the class to a file

            // Define directory for output
            String ClassesPath = $"{System.Environment.GetFolderPath(System.Environment.SpecialFolder.MyDocuments)}/PersonalDataWarehouse/Databases/{CurrentDatabaseName}/Classes";

            // Set the file path
            string filePath = $@"{ClassesPath}/{CurrentViewNameWithoutDatabase}.cs";

            // Write the class to file
            File.WriteAllText(filePath, codeBuilder.ToString());

            // **********************
            // ** Create the xsd file
            // **********************

            // Load the class and generate the schema
            // Load the class by using its name and get its type
            var codeFile = Path.Combine(ClassesPath, $"{CurrentViewNameWithoutDatabase}.cs");

            if (!System.IO.File.Exists(codeFile))
            {
                Message = $"{codeFile} Code file not found.";
                return;
            }

            // Load the code from the file
            var code = System.IO.File.ReadAllText(codeFile);

            // Get the Type for the class we want to generate the RDL for
            var ClassType = XsdGenerator.GetTypeFromCode(code, DataService.FirstCharToUpper(CurrentViewNameWithoutDatabase));

            // If the class type is not null, generate the schema
            if (ClassType != null)
            {
                // Step 1: Generate the schema string
                string schemaString = XsdGenerator.GenerateSchemaForType(ClassType);

                // Step 3: Save the file
                string DataPath = $"{System.Environment.GetFolderPath(System.Environment.SpecialFolder.MyDocuments)}/PersonalDataWarehouse/Databases/{CurrentDatabaseName}/Reports/Data";
                filePath = Path.Combine(DataPath, $"{CurrentViewNameWithoutDatabase}Schemas.xsd");
                File.WriteAllText(filePath, schemaString);
            }

            CurrentViewName = $"{CurrentDatabaseName}/{CurrentViewNameWithoutDatabase}";

            IsLoading = false;

            IsSaveViewPopupVisible = false;

            if (ContentChanged)
            {
                Message = $"{CurrentViewNameWithoutDatabase} saved!";
            }

            ContentChanged = false;

            await LoadViewsListDropdownAsync();
        }
        catch (Exception ex)
        {
            IsLoading = false;
            IsSaveViewPopupVisible = false;
            Message = ex.GetBaseException().Message;
            await _LogService.WriteToLogAsync(Message);
        }
    }

    // Table Dropdown

    private async Task LoadTableListDropdownAsync()
    {
        TableList = new List<string>();
        TableList = await databaseService.GetAllTablesAsync();
    }

    // Views Dropdown

    private async Task LoadViewsListDropdownAsync()
    {
        ViewList = new List<string>();
        ViewList = await databaseService.GetAllViewsAsync();
    }

    private async Task LoadViewAsync(string paramView)
    {
        // Separate the view name from the database
        var (Database, View) = DataService.ExtractDatabaseAndTable(paramView);

        // Load the DataTable
        String viewsFolder = $"{System.Environment.GetFolderPath(System.Environment.SpecialFolder.MyDocuments)}/PersonalDataWarehouse/Databases/{Database}/Views";

        var fileName = $"{viewsFolder}/{View}.view";

        if (System.IO.File.Exists(fileName))
        {
            // Read contents into CurrentScript
            CurrentScript = System.IO.File.ReadAllText(fileName);

            MonacoLanguage = DataService.GetDetectedLanguage(CurrentScript);
            await MonacoCodeEditor.UpdateCodeAsync(CurrentScript);

            // Update the Undo/Redo stacks
            undoStack.Clear();
            redoStack.Clear();
            undoStack.Push(CurrentScript);

            // Set CurrentViewName
            CurrentViewName = paramView;
        }
        else
        {
            Message = "View not found.";
        }
    }

    // Delete

    private async Task DeleteAsync()
    {
        if (CurrentViewName.Trim().Length == 0)
        {
            Message = "Must save view first.";
        }
        else
        {
            // Separate the view name from the database
            var (Database, View) = DataService.ExtractDatabaseAndTable(CurrentViewName);

            // Delete the file
            String viewsFolder = $"{System.Environment.GetFolderPath(System.Environment.SpecialFolder.MyDocuments)}/PersonalDataWarehouse/Databases/{Database}/Views";

            var fileName = Path.Combine(viewsFolder, $"{View}.view");
            if (System.IO.File.Exists(fileName))
            {
                System.IO.File.Delete(fileName);
            }

            // Delete the C# class file
            String ClassesFolder = $"{System.Environment.GetFolderPath(System.Environment.SpecialFolder.MyDocuments)}/PersonalDataWarehouse/Databases/{Database}/Classes";

            fileName = Path.Combine(ClassesFolder, $"{View}.cs");
            if (System.IO.File.Exists(fileName))
            {
                System.IO.File.Delete(fileName);
            }

            // Delete the XSD file
            String ReportsDataFolder = $"{System.Environment.GetFolderPath(System.Environment.SpecialFolder.MyDocuments)}/PersonalDataWarehouse/Databases/{Database}/Reports/Data";

            fileName = Path.Combine(ReportsDataFolder, $"{View}Schemas.xsd");
            if (System.IO.File.Exists(fileName))
            {
                System.IO.File.Delete(fileName);
            }

            string deletedViewName = View;
            CurrentViewName = string.Empty;

            Message = $"{deletedViewName} deleted!";

            ShowDeleteConfirmation = false;

            await LoadViewsListDropdownAsync();

            if (ViewList.Count > 0)
            {
                CurrentViewName = ViewList.First();
                await LoadViewAsync(CurrentViewName);
            }
            else
            {
                CurrentScript = SampleCodeCSharp;
                MonacoLanguage = DataService.GetDetectedLanguage(CurrentScript);
                await MonacoCodeEditor.UpdateCodeAsync(CurrentScript);
            }
        }
    }

    // New View

    private List<string> LanguageList = new List<string>
    {
        "C#",
        "Python"
    };

    private void NewScript()
    {
        IsNewViewVisible = true;
    }

    private void CloseNewScriptPopup()
    {
        IsNewViewVisible = false;
    }

    private async Task onLanguageSelectedAsync()
    {
        string SelectedCode = "";

        if (CurrentSelectedLanguageWizard == "Python")
        {
            SelectedCode = SampleCodePython;
        }
        else if (CurrentSelectedLanguageWizard == "C#")
        {
            SelectedCode = SampleCodeCSharp;
        }

        // Save the current script
        CurrentScript = await MonacoCodeEditor.GetCodeAsync();

        if (CurrentScript != "")
        {
            // Update the Undo/Redo stacks
            undoStack.Push(CurrentScript);
        }

        CurrentScript = SelectedCode;
        CurrentViewName = "";

        MonacoLanguage = DataService.GetDetectedLanguage(CurrentScript);
        await MonacoCodeEditor.UpdateCodeAsync(CurrentScript);

        IsNewViewVisible = false;
    }

    // Table Wizard

    private async Task onTableWizardAsync()
    {
        // Save the current script
        CurrentScript = await MonacoCodeEditor.GetCodeAsync();

        if (CurrentScript != "")
        {
            // Update the Undo/Redo stacks
            undoStack.Push(CurrentScript);
        }

        if (string.IsNullOrEmpty(CurrentSelectedTableWizard))
        {
            Message = "Please select a table.";
            return;
        }

        // Separate the view name from the database
        var (DatabaseName, TableName) = DataService.ExtractDatabaseAndTable(CurrentSelectedTableWizard);

        if (CurrentSelectedLanguageWizard == "Python")
        {
            CurrentScript = $"# Import the pandas library for data manipulation\n";
            CurrentScript += $"import pandas as pd\n";
            CurrentScript += $"\n";
            CurrentScript += $"# Define a function named load_data\n";
            CurrentScript += $"def load_data():\n";
            CurrentScript += $"    # Construct the file path using the database and table name\n";
            CurrentScript += $"    filepath = '{DatabaseName}/{TableName}'\n";
            CurrentScript += $"\n";
            CurrentScript += $"    # Use pandas to read the Parquet file with read_parquet\n";
            CurrentScript += $"    df = pd.read_parquet(filepath)\n";
            CurrentScript += $"\n";
            CurrentScript += $"    # Use the head() method to select only the top 10 rows of the DataFrame\n";
            CurrentScript += $"    df_top10 = df.head(10)\n";
            CurrentScript += $"\n";
            CurrentScript += $"    # Return the top 10 rows as a DataFrame\n";
            CurrentScript += $"    return df_top10\n";
        }
        else if (CurrentSelectedLanguageWizard == "C#")
        {
            CurrentScript = $"using System;\n";
            CurrentScript += $"using System.Collections.Generic;\n";
            CurrentScript += $"using System.Linq;\n";
            CurrentScript += $"using System.Threading.Tasks;\n";
            CurrentScript += $"\n";
            CurrentScript += $"public async Task<IEnumerable<IDictionary<string, object>>> ReturnResult()\n";
            CurrentScript += "{\n";
            CurrentScript += $"    // Create a Dataloader \n";
            CurrentScript += $"    Dataloader objDataloader = new Dataloader();\n";
            CurrentScript += $"    // Call LoadParquet to load {TableName} into col{TableName} \n";
            CurrentScript += $@"    var col{TableName} = await objDataloader.LoadParquet(""{DatabaseName}"",""{TableName}"");";
            CurrentScript += $"\n";
            CurrentScript += $"    // Return the results ToDictionary()  \n";
            CurrentScript += $"    return col{TableName}.Select(row => row.ToDictionary()).Take(100).ToList();";
            CurrentScript += "\n";
            CurrentScript += "}\n";
        }        

        CloseTableWizardPopup();

        CurrentSelectedTableWizard = "";

        MonacoLanguage = DataService.GetDetectedLanguage(CurrentScript);
        await MonacoCodeEditor.UpdateCodeAsync(CurrentScript);
    }

    // Popups

    private void OpenWizard()
    {
        CurrentSelectedTableWizard = TableList.FirstOrDefault();
        CurrentViewName = ""; // So the new View name popup will show on Save
        IsWizardVisible = true;
    }

    private void CloseNewViewPopup()
    {
        IsSaveViewPopupVisible = false;
    }

    private void CloseOutputTablePopup()
    {
        IsNewOutputPopupVisible = false;
    }

    private void CloseTableWizardPopup()
    {
        IsWizardVisible = false;
    }

    private void CloseMessagePopup()
    {
        Message = "";
    }

    private void DeleteConfirmation()
    {
        ShowDeleteConfirmation = true;
    }

    private void CloseDeleteConfirmationPopup()
    {
        ShowDeleteConfirmation = false;
    }

    private void CloseExportPopup()
    {
        IsExportVisible = false;
    }

    private async Task Reset()
    {
        CurrentScript = SampleCodeCSharp;
        MonacoLanguage = DataService.GetDetectedLanguage(CurrentScript);
        await MonacoCodeEditor.UpdateCodeAsync(CurrentScript);
        CurrentViewName = ViewList.First();
        await LoadViewAsync(CurrentViewName);
    }

    // Duplicates

    #region public static bool DetectDuplicates(string paramDatabaseName, string paramViewName)
    public static bool DetectDuplicates(string paramDatabaseName, string paramViewName)
    {
        bool result = false;

        // Check if the table name already exists
        String folderPath = $"{System.Environment.GetFolderPath(System.Environment.SpecialFolder.MyDocuments)}/PersonalDataWarehouse/Databases/{paramDatabaseName}/Parquet";

        string fileName = $"{folderPath}/{paramViewName}.parquet";
        var ParquetExists = System.IO.File.Exists(fileName);

        String ReportsFolderPath = $"{System.Environment.GetFolderPath(System.Environment.SpecialFolder.MyDocuments)}/PersonalDataWarehouse/{paramDatabaseName}/Reports";

        fileName = $"{ReportsFolderPath}/{paramViewName}.rdlc";
        var ViewExists = System.IO.File.Exists(fileName);

        if (ParquetExists || ViewExists)
        {
            result = true;
        }

        return result;
    }
    #endregion

    // Code Execution

    #region RunCode
    private async Task Execute()
    {
        try
        {
            if (CurrentViewName == "")
            {
                // Open a popup to enter the view name
                IsSaveViewPopupVisible = true;
                return;
            }

            // Separate the view name from the database
            var (Database, View) = DataService.ExtractDatabaseAndTable(CurrentViewName);

            CurrentViewNameWithoutDatabase = View;

            // Get the current script
            CurrentScript = await MonacoCodeEditor.GetCodeAsync();

            //  Save the view
            await SaveViewAsync();

            IsOutputLoading = true;
            IsNewOutputPopupVisible = true;
            StateHasChanged();

            // Execute the code
            var objResult = await RunDynamicCode(CurrentScript);

            if (objResult != null)
            {
                // Parse objDataParametersResult.data to a list of dictionaries
                var columns = objResult.Select(x => x.ToDictionary(y => y.Key, y => y.Value)).FirstOrDefault();

                objDataParameters = new DataParameters
                    {
                        data = objResult,
                        columns = columns.ToDictionary(x => x.Key, x => Type.GetType("System.String"))
                    };
            }

            // If there is a message, display it
            // Otherwise, display the data
            if (Message != "")
            {
                IsNewOutputPopupVisible = false;
            }
            else
            {
                IsNewOutputPopupVisible = true;
            }

            IsOutputLoading = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            IsNewOutputPopupVisible = false;
            IsOutputLoading = false;
            Message = ex.GetBaseException().Message;
            await _LogService.WriteToLogAsync(Message);
            StateHasChanged();
        }
    }

    public async Task<IEnumerable<IDictionary<string, object>>> RunDynamicCode(string paramCode)
    {
        List<Dictionary<string, object>> dataRows = new();

        try
        {            
            if (paramCode.Contains("def load_data()"))
            {
                // Python code
                // Call JS to execute Python via Pyodide and get JSON
                var json = await JSRuntime.InvokeAsync<string>("runPythonScript", new object[] { paramCode });

                // Parse and flatten JSON into a table-friendly format
                dataRows = new List<Dictionary<string, object>>();
                var parsedArray = JsonNode.Parse(json)?.AsArray();

                if (parsedArray != null)
                {
                    foreach (var item in parsedArray)
                    {
                        var dict = new Dictionary<string, object>();
                        if (item is JsonObject obj)
                        {
                            foreach (var prop in obj)
                            {
                                dict[prop.Key] = prop.Value?.GetValue<object>() ?? "";
                            }
                        }
                        dataRows.Add(dict);
                    }
                }

                return dataRows as IEnumerable<IDictionary<string, object>>;
            } 
            else if (paramCode.Contains("public async Task<IEnumerable<IDictionary<string, object>>> ReturnResult()"))
            {
                // C# Code
                dynamic script = CSScript.Evaluator.LoadMethod(paramCode);

                var result = await script.ReturnResult();

                return result as IEnumerable<IDictionary<string, object>>;
            }
            else
            {
                Message = "Invalid code.";
                return null;
            }            
        }
        catch (Exception ex)
        {
            Message = ex.GetBaseException().Message;
            await _LogService.WriteToLogAsync(Message);
            return null;
        }
    }
    #endregion

    // Exports

    private void Export()
    {
        if (CurrentViewName.Trim().Length == 0)
        {
            // Open the Save Table popup
            SaveViewName();
        }
        else
        {
            IsExportVisible = true;

            // Separate the view name from the database
            var (Database, View) = DataService.ExtractDatabaseAndTable(CurrentViewName);

            CurrentViewNameWithoutDatabase = View;
        }
    }

    private async Task ExportExcel()
    {
        // Note: CurrentViewNameWithoutDatabase was set in the Export method

        IsLoadingSheet = true;

        // Get the current script
        CurrentScript = await MonacoCodeEditor.GetCodeAsync();

        //  Save the view
        await SaveViewAsync();

        // Execute the code
        var objResult = await RunDynamicCode(CurrentScript);

        if (objResult == null)
        {
            Message = "No data to export.";
            IsLoadingSheet = false;
            IsExportVisible = false;
            return;
        }
        // Parse objDataParametersResult.data to a list of dictionaries
        var columns = objResult.Select(x => x.ToDictionary(y => y.Key, y => y.Value)).FirstOrDefault();

        objDataParameters = new DataParameters
            {
                data = objResult,
                columns = columns.ToDictionary(x => x.Key, x => Type.GetType("System.String"))
            };

        // Turn data into a DataTable
        DataTable dt = DataService.ConvertToDataTable(objDataParameters.data, objDataParameters.columns);

        // Export the DataTable to Excel
        byte[] ExcelContents = await DataService.ExportDataTableToExcelAsync(dt, CurrentViewNameWithoutDatabase);

        // Read DocumentContents into a MemoryStream
        var stream = new MemoryStream(ExcelContents);

        var FileName = $"{CurrentViewNameWithoutDatabase}.xlsx";

        var picker = new Windows.Storage.Pickers.FileSavePicker
            {
                SuggestedStartLocation = Windows.Storage.Pickers.PickerLocationId.Downloads
            };

        picker.FileTypeChoices.Add("All Files", new List<string> { ".xlsx" });
        picker.SuggestedFileName = FileName;

        var hwnd = ((MauiWinUIWindow)App.Current.Windows[0].Handler.PlatformView).WindowHandle;
        WinRT.Interop.InitializeWithWindow.Initialize(picker, hwnd);

        var fileSaverResult = await picker.PickSaveFileAsync();

        if (fileSaverResult != null)
        {
            // Convert the MemoryStream to a byte array
            byte[] fileContent = stream.ToArray();

            // Write the content to the selected path
            await File.WriteAllBytesAsync(fileSaverResult.Path, fileContent);
        }
        else
        {
            Message = $"Export to Excel cancelled.";
        }

        IsLoadingSheet = false;
        IsExportVisible = false;
    }

    private async Task ExportParquet()
    {
        // Note: CurrentViewNameWithoutDatabase was set in the Export method

        IsLoadingSheet = true;

        // Get the current script
        CurrentScript = await MonacoCodeEditor.GetCodeAsync();

        //  Save the view
        await SaveViewAsync();

        // Execute the code
        var objResult = await RunDynamicCode(CurrentScript);

        if (objResult == null)
        {
            Message = "No data to export.";
            IsLoadingSheet = false;
            IsExportVisible = false;
            return;
        }
        // Parse objDataParametersResult.data to a list of dictionaries
        var columns = objResult.Select(x => x.ToDictionary(y => y.Key, y => y.Value)).FirstOrDefault();

        objDataParameters = new DataParameters
            {
                data = objResult,
                columns = columns.ToDictionary(x => x.Key, x => Type.GetType("System.String"))
            };

        // Turn data into a DataTable
        DataTable dt = DataService.ConvertToDataTable(objDataParameters.data, objDataParameters.columns);

        // Export the DataTable to Parquet
        byte[] ParquetContents = await DataService.ExportDataTableToParquetAsync(dt, CurrentViewNameWithoutDatabase);

        // Read DocumentContents into a MemoryStream
        var stream = new MemoryStream(ParquetContents);

        var FileName = $"{CurrentViewNameWithoutDatabase}.parquet";

        var picker = new Windows.Storage.Pickers.FileSavePicker
            {
                SuggestedStartLocation = Windows.Storage.Pickers.PickerLocationId.Downloads
            };

        picker.FileTypeChoices.Add("All Files", new List<string> { ".parquet" });
        picker.SuggestedFileName = FileName;

        var hwnd = ((MauiWinUIWindow)App.Current.Windows[0].Handler.PlatformView).WindowHandle;
        WinRT.Interop.InitializeWithWindow.Initialize(picker, hwnd);

        var fileSaverResult = await picker.PickSaveFileAsync();

        if (fileSaverResult != null)
        {
            // Convert the MemoryStream to a byte array
            byte[] fileContent = stream.ToArray();

            // Write the content to the selected path
            await File.WriteAllBytesAsync(fileSaverResult.Path, fileContent);
        }
        else
        {
            Message = $"Export to Parquet cancelled.";
        }

        IsLoadingSheet = false;
        StateHasChanged();

        IsLoadingSheet = false;
        IsExportVisible = false;
    }

    // AI

    #region AI
    private async Task AIbtn()
    {
        try
        {
            // Determine if AI is set-up

            // Get APIKey from secure settings
            string ApiKey = await SecureStorage.Default.GetAsync("AIApiKey") ?? "";

            if (string.IsNullOrEmpty(ApiKey))
            {
                if ((SettingsService.Settings.ApplicationSettings.AIType == "OpenAI") || (SettingsService.Settings.ApplicationSettings.AIType == "Azure OpenAI"))
                {
                    Message = "Please set up AI in Setings";
                    return;
                }
            }

            if ((SettingsService.Settings.ApplicationSettings.AIType == "LM Studio") || (SettingsService.Settings.ApplicationSettings.AIType == "Ollma"))
            {
                if ((SettingsService.Settings.ApplicationSettings.Endpoint.Trim() == ""))
                {
                    Message = "Please set up AI in Setings";
                    return;
                }
            }

            // Get the current script
            CurrentScript = await MonacoCodeEditor.GetCodeAsync();

            if (CurrentScript != "")
            {
                // Update the Undo/Redo stacks
                undoStack.Push(CurrentScript);
            }

            IsAILoading = true;
            StateHasChanged();

            // ** Open the View.txt template from Templates\View.txt and replace the content with the codeBuilder
            string templatePath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "Templates", "AITemplate.txt");

            // Read the content of the template file
            string templateContent = File.ReadAllText(templatePath);

            // Replace the placeholders
            string AIRequest = "";

            AIRequest = templateContent.Replace("## CURRENT SCHEMA ##", DataSchema);
            AIRequest = AIRequest.Replace("## CURRENT CODE ##", CurrentScript);
            AIRequest = AIRequest.Replace("## CURRENT REQUEST ##", AIMessage);

            var AIResponse = await OrchestratorMethods.CallOpenAIAsync(SettingsService, ApiKey, AIRequest);

            await _LogService.WriteToLogAsync($"View:AIbtn - {AIRequest}");

            IsAILoading = false;
            ShowAI = false;

            if (AIResponse.Error != "")
            {
                Message = AIResponse.Error;
                await _LogService.WriteToLogAsync($"View:AIbtn:Response:Error - {AIResponse.Error}");
                return;
            }

            await _LogService.WriteToLogAsync($"View:AIbtn:Response - {AIResponse.Response}");

            // Update the code in the editor
            MonacoLanguage = DataService.GetDetectedLanguage(AIResponse.Response);
            await MonacoCodeEditor.UpdateCodeAsync(AIResponse.Response);
        }
        catch (Exception ex)
        {
            Message = ex.GetBaseException().Message;
            await _LogService.WriteToLogAsync(Message);
        }
    }

    private void OpenAIPopup()
    {
        AIMessage = "";
        ShowAI = true;
    }

    private void CloseAIPopup()
    {
        ShowAI = false;
        Message = "";
    }
    #endregion

    private string SampleCodeCSharp = @"    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;

    public async Task<IEnumerable<IDictionary<string, object>>> ReturnResult()
    {
        // Generate random data
        return Enumerable.Range(1, 1).Select(id => new Dictionary<string, object>
        {
            { ""EmployeeId"", ""1234"" },
            { ""FirstName"", ""John"" },
            { ""LastName"", ""Doe"" }
        });
    }";

    private string SampleCodePython = @"
# Import the pandas library, commonly used for data manipulation and analysis
import pandas as pd

# Define a function named load_data
def load_data():
    # Create a DataFrame (a table-like data structure) manually using a list of dictionaries
    # Each dictionary represents a row with column names as keys
    df = pd.DataFrame([
        {'Name': 'Alice', 'Age': 30},  # First row with Name = Alice and Age = 30
        {'Name': 'Bob', 'Age': 25}     # Second row with Name = Bob and Age = 25
    ])

    # Return the created DataFrame to the caller
    return df";
}